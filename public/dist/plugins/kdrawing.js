"use strict";(function(e){var B=function(){var p='<div class="kdrawing"><div class="kdrawing_drawingboard"><canvas class="kdrawing_canvas" /><div class="kdrawing_cursor"><div class="kdrawing_cursor_icon"></div><div class="kdrawing_cursor_inner"></div></div><div class="kdrawing_cover"></div></div><div class="kdrawing_information"><p>B : \uC5F0\uD544</p><p>E : \uC9C0\uC6B0\uAC1C</p><p>G : \uD398\uC778\uD2B8\uD1B5</p><p>I : \uC2A4\uD3EC\uC774\uB4DC</p><p>U : \uC120 \uADF8\uB9AC\uAE30</p><p>Ctrl+Z, Ctrl+Y : \uC2E4\uD589 \uCDE8\uC18C, \uC7AC\uC2E4\uD589</p><p>Ctrl+S : \uC800\uC7A5</p><p>1 ~ 9 : \uD30C\uB808\uD2B8 \uC0C9\uC0C1 \uC120\uD0DD</p><p>T : \uB3C4\uAD6C \uC0C1\uC790\uB97C \uD604\uC7AC \uB9C8\uC6B0\uC2A4 \uC704\uCE58\uB85C \uC774\uB3D9</p><p>+, - : \uB3C4\uAD6C \uD06C\uAE30 \uBCC0\uACBD</p><br /><p>\uC67C\uD074\uB9AD : \uB3C4\uAD6C \uC0AC\uC6A9</p><p>\uC624\uB978\uD074\uB9AD : \uC9C0\uC6B0\uAC1C</p><p>\uD30C\uB808\uD2B8 \uC0C9\uC0C1\uC5D0 \uB300\uACE0 \uC624\uB978\uD074\uB9AD : \uD30C\uB808\uD2B8 \uC9C0\uC6B0\uAE30</p></div><div class="kdrawing_timeline"></div><div class="kdrawing_fadealert"></div></div>',l='<div class="kdrawing_toolbox kdrawing_draggable"><div class="kdrawing_draggable_handle"></div><ul class="kdrawing_toolbox_tools"><li class="kdrawing_toolbox_tool"><span class="kdrawing_toolbox_new" data-tool="new" title="\uC0C8\uB85C \uB9CC\uB4E4\uAE30"></span></li><li class="kdrawing_toolbox_tool"><span class="kdrawing_toolbox_undo" data-tool="undo" title="\uC2E4\uD589 \uCDE8\uC18C"></span></li><li class="kdrawing_toolbox_tool"><span class="kdrawing_toolbox_redo" data-tool="redo" title="\uB2E4\uC2DC \uC2E4\uD589"></span></li><li class="kdrawing_toolbox_division"></li><li class="kdrawing_toolbox_tool"><span class="kdrawing_toolbox_pencil" data-tool="pencil" title="\uC5F0\uD544"></span></li><li class="kdrawing_toolbox_tool"><span class="kdrawing_toolbox_eraser" data-tool="eraser" title="\uC9C0\uC6B0\uAC1C"></span></li><li class="kdrawing_toolbox_tool"><span class="kdrawing_toolbox_paint" data-tool="paint" title="\uD398\uC778\uD2B8\uD1B5"></span></li><li class="kdrawing_toolbox_tool"><span class="kdrawing_toolbox_eyedropper" data-tool="eyedropper" title="\uC2A4\uD3EC\uC774\uB4DC"></span></li><li class="kdrawing_toolbox_tool"><span class="kdrawing_toolbox_line" data-tool="line" title="\uC120 \uADF8\uB9AC\uAE30"></span></li><li class="kdrawing_toolbox_division"></li><li class="kdrawing_toolbox_system"><div class="kdrawing_toolbox_color"></div><button type="button" class="kdrawing_button kdrawing_toolbox_addpalette" title="\uD30C\uB808\uD2B8\uC5D0 \uC0C9\uC0C1 \uCD94\uAC00">\uFF0B</button></li><li class="kdrawing_toolbox_option"><div class="kdrawing_toolbox_size"><input class="kdrawing_toolbox_size_bar" type="range" min="1" max="10" value="2" /><br /><input class="kdrawing_toolbox_size_text" type="number" min="1" value="2" /></div><li class="kdrawing_toolbox_division"></li><li class="kdrawing_toolbox_tool"><span class="kdrawing_toolbox_save" data-tool="save" title="\uC800\uC7A5\uD558\uAE30"></span></li><li class="kdrawing_toolbox_tool"><span class="kdrawing_toolbox_load" data-tool="load" title="\uBD88\uB7EC\uC624\uAE30"></span></li><li class="kdrawing_toolbox_tool"><span class="kdrawing_toolbox_timeline" data-tool="timeline" title="\uD0C0\uC784\uB77C\uC778 \uB9CC\uB4E4\uAE30"></span></li></li></ul></div>',x='<div class="kdrawing_palette kdrawing_draggable"><div class="kdrawing_draggable_handle"></div><ul class="kdrawing_palette_colors"></ul></div>',y='<div class="kdrawing_colorpicker kdrawing_draggable"><div class="kdrawing_draggable_handle"></div><div class="kdrawing_colorpicker_wrapper"><div class="kdrawing_colorpicker_color" style="background-color: rgb(255, 0, 0);"><div class="kdrawing_colorpicker_color_overlay1"><div class="kdrawing_colorpicker_color_overlay2"><div class="kdrawing_colorpicker_selector_outer" style="left: 0px; top: 156px;"><div class="kdrawing_colorpicker_selector_inner"></div></div></div></div></div><div class="kdrawing_colorpicker_hue"><div class="kdrawing_colorpicker_hue_arrs" style="top: 0px;"><div class="kdrawing_colorpicker_hue_larr"></div><div class="kdrawing_colorpicker_hue_rarr"></div></div></div><div class="kdrawing_colorpicker_right"><div class="kdrawing_colorpicker_show_color"><div class="kdrawing_colorpicker_new_color"></div><div class="kdrawing_colorpicker_current_color"></div></div><form novalidate><div style="float: left;"><div class="kdrawing_colorpicker_hsb_h kdrawing_colorpicker_field"><div class="kdrawing_colorpicker_field_letter">H</div><input type="number" maxlength="3" size="3" min="0" max="360"></div><div class="kdrawing_colorpicker_hsb_s kdrawing_colorpicker_field"><div class="kdrawing_colorpicker_field_letter">S</div><input type="number" maxlength="3" size="3" min="0" max="100"></div><div class="kdrawing_colorpicker_hsb_b kdrawing_colorpicker_field"><div class="kdrawing_colorpicker_field_letter">B</div><input type="number" maxlength="3" size="3" min="0" max="100"></div></div><div class="kdrawing_colorpicker_rgb_box"><div class="kdrawing_colorpicker_rgb_r kdrawing_colorpicker_field"><div class="kdrawing_colorpicker_field_letter">R</div><input type="number" maxlength="3" size="3" min="0" max="255"></div><div class="kdrawing_colorpicker_rgb_g kdrawing_colorpicker_field"><div class="kdrawing_colorpicker_field_letter">G</div><input type="number" maxlength="3" size="3" min="0" max="255"></div><div class="kdrawing_colorpicker_rgb_b kdrawing_colorpicker_field"><div class="kdrawing_colorpicker_field_letter">B</div><input type="number" maxlength="3" size="3" min="0" max="255"></div></div><div style="clear: both;"></div><div class="kdrawing_colorpicker_hex kdrawing_colorpicker_field"><div class="kdrawing_colorpicker_field_letter">#</div><input type="text" maxlength="6" size="6"></div><div class="kdrawing_colorpicker_buttons"><button type="submit" class="kdrawing_button kdrawing_colorpicker_submit">\uD655\uC778</button><button type="button" class="kdrawing_button kdrawing_colorpicker_cancel">\uCDE8\uC18C</button><div style="clear: both;"></div></div></form></div></div></div>',S='<div class="kdrawing_alertwindow kdrawing_draggable"><div class="kdrawing_draggable_handle"></div><form novalidate><div class="kdrawing_alertwindow_size kdrawing_alertwindow_form"><input type="text" name="width" /><span class="kdrawing_alertwindow_size_center">x</span><input type="text" name="height" /><div class="kdrawing_alertwindow_size_keep"><label><input type="checkbox" name="keep" /> \uADF8\uB9BC \uC720\uC9C0</label></div><div class="kdrawing_alertwindow_buttons"><button type="submit" class="kdrawing_button">\uD655\uC778</button><button type="button" class="kdrawing_button kdrawing_alertwindow_close">\uCDE8\uC18C</button></div></div><div class="kdrawing_alertwindow_alert kdrawing_alertwindow_form"><div class="kdrwaing_alertwindow_text"></div><div class="kdrawing_alertwindow_buttons"><button type="submit" class="kdrawing_button">\uD655\uC778</button></div></div></form></div>',k={last:{x:0,y:0},tool_id:"pencil",tool_id_org:!1,tool:{pencil:{size:2},eraser:{size:10}},color:{h:0,s:0,b:0},colors:[{h:300,s:0,b:0},{h:300,s:0,b:100},{h:0,s:100,b:100},{h:120,s:100,b:100},{h:240,s:100,b:100},{h:60,s:100,b:100},{h:180,s:100,b:100},{h:300,s:100,b:100}],adjust:{x:0,y:0},history:{undo:[],redo:[]},canvas:!1,drawingboard:!1,cursor:!1,toolbox:!1,palette:!1,colorpicker:!1,alertwindow:!1,alertwindow_id:!1,customCursor:!0,customCursorDot:!0,carefulAction:!1,colorpickerImmediately:!1,mousePos:{x:0,y:0},onReady:function(){},onChange:function(){},onSave:function(){},onLoad:function(){}},C=function(a){var t=prompt("\uD0C0\uC784\uB77C\uC778\uC744 \uBA87 \uB2E8\uACC4\uB85C \uB9CC\uB4DC\uC2DC\uACA0\uC2B5\uB2C8\uAE4C?",5);if(!(!t||t<=0||isNaN(t))){var o=[],n=e(a).data("data").history.undo,i=Math.ceil(n.length/(t*1+1));e(a).find(".kdrawing_timeline").empty();for(var c=0,f=i;f<n.length;f+=i)o.push(n[f]),e(a).find(".kdrawing_timeline").append('<img src="'+n[f]+'" width="100" />'),c++}},z=function(a,t,o){o=typeof o<"u"?o:!0;var n=e(a).find(".kdrawing_fadealert");n.text(t),o?n.stop(!0,!0).fadeIn(100).delay(500).fadeOut(100):n.stop(!0,!0).fadeIn(100)},ea=function(a,t){if(e(a).data("data").alertwindow_id){e(a).data("data").alertwindow.stop(!0,!0).fadeIn(100).fadeOut(100).fadeIn(100).fadeOut(100).fadeIn(100);return}if(!!t){e(a).data("data").alertwindow_id=t.id;var o=e(a).data("data").alertwindow;switch(o.show(),o.find(".kdrawing_alertwindow_form").hide(),o.find(".kdrawing_alertwindow_"+t.id).show(),o.find("form").off("submit"),o.find("form").on("submit",function(n){n.preventDefault();var i=!1;if(t.onSubmit){var c={};e.each(e(this).serializeArray(),function(f,v){c[v.name]=v.value}),i=t.onSubmit.apply(e(this),[c])}i||oa(a)}),t.id){case"size":t.width&&o.find(".kdrawing_alertwindow_size input[name='width']").val(t.width),t.height&&o.find(".kdrawing_alertwindow_size input[name='height']").val(t.height);break;case"alert":t.text&&o.find(".kdrwaing_alertwindow_text").html(t.text);break}}},oa=function(a){var t=e(a).data("data").alertwindow;e(a).data("data").alertwindow_id=!1,t.hide()},K=function(a,t,o){if(isNaN(t)||isNaN(o)||!t||t<50||t>1280||!o||o<50||o>1600)return alert("50px \uC774\uC0C1, \uAC00\uB85C 1280px \uC774\uD558, \uC138\uB85C 1600px \uC774\uD558\uB85C \uC785\uB825\uD574\uC8FC\uC138\uC694."),!1;e(a).data("data").width=t,e(a).data("data").height=o,e(a).data("data").drawingboard.css({width:t,height:o});var n=e(a).data("data").canvas.get(0);return n.width=t,n.height=o,!0},U=function(a,t){t||(e(a).data("data").history.undo=[],e(a).data("data").history.redo=[]),e(a).find(".kdrawing_timeline").empty();var o=e(a).data("data").canvas.get(0),n=o.getContext("2d");n.fillStyle="#FFF",n.fillRect(0,0,o.width,o.height)},ia=function(a,t){var o=e(a).data("data").palette.find(".kdrawing_palette_colors");o.append(e("<li />").css({"background-color":"#"+Y(t)})),e(a).data("data").colors.push(t)},na=function(a){var t=e(a).data("data").colors;va(a);for(var o in t)ia(a,t[o])},va=function(a){e(a).data("data").palette.find(".kdrawing_palette_colors li").remove(),e(a).data("data").colors=[]},da=function(a){if(!!e(a).data("data").customCursor){var t=e(a).data("data").drawingboard,o=e(a).data("data").cursor,n=o.find(".kdrawing_cursor_inner"),i=o.find(".kdrawing_cursor_icon"),c=Y(e(a).data("data").color),f={top:o.css("top"),left:o.css("left")};t.removeClass().addClass("kdrawing_drawingboard"),o.hide().attr("style","").css({top:f.top,left:f.left}),n.hide().attr("style",""),i.hide().attr("style","").removeClass().addClass("kdrawing_cursor_icon");var v=e(a).data("data").tool_id,s=e(a).data("data").tool[e(a).data("data").tool_id];switch(v){case"pencil":s.size==1?e(a).data("data").customCursorDot&&t.addClass("kdrawing_crosshaircursor"):(t.addClass("kdrawing_disablecursor"),o.show().css({width:s.size,height:s.size,"border-width":1,"border-style":"solid","border-color":"black","border-radius":"50%"}),n.show().css({top:0,left:0,right:0,bottom:0,"border-width":1,"border-style":"solid","border-color":"white","border-radius":"50%"})),i.hide().removeClass().addClass("kdrawing_cursor_icon");break;case"paint":case"line":t.addClass("kdrawing_disablecursor"),o.show().css({width:4,height:4,margin:"3px 0 0 3px","border-width":"2px 0 0 2px","border-style":"solid","border-color":"#"+c}),i.show().addClass("kdrawing_cursor_icon_"+v);break;case"eraser":t.addClass("kdrawing_disablecursor"),o.show().css({width:s.size,height:s.size,"border-width":1,"border-style":"solid","border-color":"black","border-radius":"50%"}),n.show().css({top:0,left:0,right:0,bottom:0,"border-width":1,"border-style":"solid","border-color":"white","border-radius":"50%"}),i.hide().removeClass().addClass("kdrawing_cursor_icon");break;case"eyedropper":t.addClass("kdrawing_disablecursor"),i.show().addClass("kdrawing_cursor_icon_eyedropper");break}}},q=function(a,t){typeof t=="string"?t=R(t):t.r!=null&&t.g!=null&&t.b!=null?t=D(t):t.h!=null&&t.s!=null&&t.b!=null?t=P(t):t=k.color;var o=e(a).data("data").toolbox;o.find(".kdrawing_toolbox_system .kdrawing_toolbox_color").css("background-color","#"+Y(t)),e(a).data("data").color=t,la(a)},G=function(a,t){!e(a).data("data").tool_id||e(a).data("data").toolbox.find(".kdrawing_toolbox_size_text").is(":hidden")||isNaN(t)||(t>100&&(t=100),t<1&&(t=1),e(a).data("data").toolbox.find(".kdrawing_toolbox_size_bar, .kdrawing_toolbox_size_text").val(t),e(a).data("data").tool[e(a).data("data").tool_id].size=t,da(a))},la=function(a){var t=e(a).data("data").canvas.get(0),o=t.getContext("2d"),n=e(a).data("data").toolbox,i=Y(e(a).data("data").color);n.find(".kdrawing_toolbox_option div").hide();var c=e(a).data("data").tool_id,f=e(a).data("data").tool[e(a).data("data").tool_id];switch(c){case"pencil":case"line":n.find(".kdrawing_toolbox_option .kdrawing_toolbox_size").show().find("input").val(f.size),o.fillStyle=i?"#"+i:"#000";break;case"paint":case"eyedropper":o.fillStyle=i?"#"+i:"#000";break;case"eraser":n.find(".kdrawing_toolbox_option .kdrawing_toolbox_size").show().find("input").val(f.size),o.fillStyle="#FFF";break}da(a)},M=function(a,t){switch(t){case"new":var o=e(a).data("data").canvas.get(0),n=o.getContext("2d");ea(a,{id:"size",width:o.width,height:o.height,onSubmit:function(u){if(u.keep)var d=e(a).data("data").canvas.get(0).toDataURL();if(K(a,u.width,u.height)){if(u.keep){U(a,!0);var w=new Image;w.src=d,w.onload=function(){n.drawImage(w,0,0)}}else U(a);return X(a,e(a).data("data").tool_id),!1}else return!0}}),e(a).data("data").alertwindow.find("input:visible:eq(0)").focus();break;case"undo":case"redo":var o=e(a).data("data").canvas.get(0),n=o.getContext("2d"),i=t,c=t=="undo"?"redo":"undo",f=e(a).data("data").history[i];if(!f.length)return;var v=e(a).data("data").history[c],s=new Image;s.src=f.pop(),v.push(o.toDataURL()),s.onload=function(){n.drawImage(s,0,0),e(a).data("data").onChange.apply(e(a).parent(),[e(a).data("data").canvas.get(0).toDataURL(),e(a).data("data")])};break;case"save":if(e(a).data("data").carefulAction){var _=confirm("\uC800\uC7A5\uD558\uC2DC\uACA0\uC2B5\uB2C8\uAE4C?");if(!_)return}e(a).data("data").onSave.apply(e(a).parent(),[e(a).data("data").canvas.get(0).toDataURL(),jQuery.extend(!0,{},e(a).data("data"))]);break;case"load":if(e(a).data("data").carefulAction){var _=confirm("\uBD88\uB7EC\uC624\uC2DC\uACA0\uC2B5\uB2C8\uAE4C?");if(!_)return}try{z(a,"\uBD88\uB7EC\uC624\uB294 \uC911...",!1),e(a).data("data").onLoad(function(u){console.log(u);var d=u;e(a).data("data",e.extend({},e(a).data("data"),d.data||{}));var w=e(a).data("data");K(a,w.width,w.height),U(a,!0);var h=e(a).data("data").canvas.get(0),I=h.getContext("2d"),m=new Image;m.src=d.url,m.onload=function(){I.drawImage(m,0,0),z(a,"\uBD88\uB7EC\uC624\uAE30 \uC644\uB8CC."),e(a).data("data").onChange.apply(e(a),[e(a).data("data").canvas.get(0).toDataURL(),e(a).data("data")])},m.onerror=function(){z(a,"\uBD88\uB7EC\uC624\uAE30 \uC2E4\uD328"),alert("\uC800\uC7A5 \uB0B4\uC6A9\uC774 \uC62C\uBC14\uB974\uC9C0 \uC54A\uC544 \uADF8\uB9BC \uBD88\uB7EC\uC624\uAE30\uC5D0 \uC2E4\uD328\uD588\uC2B5\uB2C8\uB2E4.")},na(a),X(a,w.tool_id?w.tool_id:k.tool_id),q(a,w.color?w.color:k.color)})}catch(u){prompt(`\uBD88\uB7EC\uC624\uB294 \uC911 \uC624\uB958\uAC00 \uBC1C\uC0DD\uD588\uC2B5\uB2C8\uB2E4.
\uC544\uB798 \uB0B4\uC6A9\uC744 \uBCF5\uC0AC\uD574\uC11C \uBB38\uC758\uD574\uC8FC\uC138\uC694.
`,u.message+" / "+JSON.stringify(loadData))}break;case"timeline":C(a);break;default:X(a,t);break}},X=function(a,t){e(a).data("data").tool_id=t,e(a).data("data").tool[t]||(e(a).data("data").tool[t]={size:1});var o=e(a).data("data").tool[e(a).data("data").tool_id],n=e(a).data("data").toolbox;la(a),n.find(".kdrawing_toolbox_tools li.kdrawing_toolbox_tool").removeClass("selected"),n.find(".kdrawing_toolbox_"+t).parent("li").addClass("selected")},Q=function(a){var t=e(a).data("data").canvas.get(0);e(a).data("data").history.undo.push(t.toDataURL()),e(a).data("data").history.undo.length>100&&(e(a).data("data").history.undo=e(a).data("data").history.undo.slice(-100)),e(a).data("data").history.redo=[]},H=function(a,t,o,n){var i=e(a).data("data").adjust;switch(t+=i.x,o+=i.y,e(a).data("data").tool_id){case"pencil":case"eraser":n=="mousedown"&&Q(a),V(a,t,o,n=="mouseenter"||n=="mousedown");break;case"line":n=="mousedown"?(Q(a),V(a,t,o,!0)):(n=="mouseup"||n=="mouseleave")&&V(a,t,o);break;case"paint":n=="mousedown"&&Q(a),wa(a,t,o);break;case"eyedropper":ba(a,t,o);break;case"hand":n=="mousedown"?(e("body").addClass("clicked"),e(a).data("data").last.x=t,e(a).data("data").last.y=o):n=="mouseup"?e("body").removeClass("clicked"):n=="mousemove"&&e("body").hasClass("clicked")&&(e(window).scrollTop(e(window).scrollTop()+(e(a).data("data").last.y-o)),e(window).scrollLeft(e(window).scrollLeft()+(e(a).data("data").last.x-t)));break}e(a).data("data").onChange.apply(e(a),[e(a).data("data").canvas.get(0).toDataURL(),e(a).data("data")])},V=function(a,t,o,n){var i=e(a).data("data").last.x,c=e(a).data("data").last.y;if(e(a).data("data").last.x=t,e(a).data("data").last.y=o,n)J(a,t,o);else{var f=t,v=i,s=o,_=c,u=Math.abs(_-s)>Math.abs(v-f);if(u){var t=f;f=s,s=t;var o=_;_=v,v=o}if(f>v){var t=f;f=v,v=t;var o=s;s=_,_=o}var d=v-f,w=Math.abs(_-s),h=0,I=w/d,m=-1,o=s;s<_&&(m=1);for(var t=f;t<=v;t++)u?J(a,o,t):J(a,t,o),h+=I,h>=.5&&(o+=m,h-=1)}},J=function(a,t,o){var n=e(a).data("data").canvas.get(0),i=n.getContext("2d"),c=e(a).data("data").tool[e(a).data("data").tool_id].size;c==1?i.fillRect(t,o,1,1):(i.beginPath(),i.arc(t,o,c/2,0,2*Math.PI),i.fill())},wa=function(a,t,o){var n=e(a).data("data").canvas.get(0),i=n.getContext("2d"),c=i.getImageData(0,0,n.width,n.height),f=(o*n.width+t)*4,v=W(e(a).data("data").color),s=c.data[f],_=c.data[f+1],u=c.data[f+2],d=c.data[f+3];s===v.r&&_===v.g&&u===v.b||_a(a,t,o,s,_,u,c,v)},_a=function(a,t,o,n,i,c,f,v){for(var s=e(a).data("data").canvas.get(0),_=s.getContext("2d"),u,d,w,h,I,m,A=s.width,Sa=s.height,Ma=0,Da=0,Ya=A-1,Xa=Sa-1,L=[[t,o]];L.length;){for(u=L.pop(),d=u[0],w=u[1],h=(w*A+d)*4;w>=Da&&E(h,n,i,c,f,v);)w-=1,h-=A*4;for(h+=A*4,w+=1,I=!1,m=!1;w<=Xa&&E(h,n,i,c,f,v);)ha(h,v.r,v.g,v.b,void 0,f),d>Ma&&(E(h-4,n,i,c,f,v)?I||(L.push([d-1,w]),I=!0):I&&(I=!1)),d<Ya&&(E(h+4,n,i,c,f,v)?m||(L.push([d+1,w]),m=!0):m&&(m=!1)),h+=A*4,w+=1}_.fillStyle="#FFF",_.fillRect(0,0,s.width,s.height),_.putImageData(f,0,0)},E=function(a,t,o,n,i,c){return r=i.data[a],g=i.data[a+1],b=i.data[a+2],r===t&&g===o&&b===n?!0:(r===c.r&&g===c.g&&b===c.b,!1)},ha=function(a,t,o,n,i,c){c.data[a]=t,c.data[a+1]=o,c.data[a+2]=n,c.data[a+3]=i!==void 0?i:255},ba=function(a,t,o){var n=e(a).data("data").canvas.get(0),i=n.getContext("2d"),c=i.getImageData(t,o,1,1).data;q(a,D({r:c[0],g:c[1],b:c[2]}))},ma=function(a){a.preventDefault(),e(this).parent(".kdrawing_draggable").addClass("dragging").data("top",a.offsetY).data("left",a.offsetX)},O=function(a,t,o,n){var i=e(t).attr("id","kdrawing_"+a);return i.find(".kdrawing_draggable_handle").on("mousedown",ma),i.offset({top:o,left:n}),i},F=function(a,t){var o=W(a);e(t).data("colorpicker").fields.eq(3).val(o.r).end().eq(4).val(o.g).end().eq(5).val(o.b).end()},j=function(a,t){e(t).data("colorpicker").fields.eq(0).val(Math.round(a.h)).end().eq(1).val(Math.round(a.s)).end().eq(2).val(Math.round(a.b)).end()},T=function(a,t){e(t).data("colorpicker").fields.eq(6).val(Y(a))},Z=function(a,t){e(t).data("colorpicker").selector.css("backgroundColor","#"+Y({h:a.h,s:100,b:100})),e(t).data("colorpicker").selectorIndic.css({left:parseInt(e(t).data("colorpicker").height*a.s/100,10),top:parseInt(e(t).data("colorpicker").height*(100-a.b)/100,10)})},$=function(a,t){e(t).data("colorpicker").hue.css("top",parseInt(e(t).data("colorpicker").height-e(t).data("colorpicker").height*a.h/360,10))},ra=function(a,t){e(t).data("colorpicker").currentColor.css("backgroundColor","#"+Y(a))},aa=function(a,t){e(t).data("colorpicker").newColor.css("backgroundColor","#"+Y(a))},N=function(a){var t=e(this).parents(".kdrawing_colorpicker"),o;this.parentNode.className.indexOf("_hex")>0?(t.data("colorpicker").color=o=R(Ca(this.value)),F(o,t.get(0)),j(o,t.get(0))):this.parentNode.className.indexOf("_hsb")>0?(t.data("colorpicker").color=o=P({h:parseInt(t.data("colorpicker").fields.eq(0).val(),10),s:parseInt(t.data("colorpicker").fields.eq(1).val(),10),b:parseInt(t.data("colorpicker").fields.eq(2).val(),10)}),F(o,t.get(0)),T(o,t.get(0))):(t.data("colorpicker").color=o=D(ya({r:parseInt(t.data("colorpicker").fields.eq(3).val(),10),g:parseInt(t.data("colorpicker").fields.eq(4).val(),10),b:parseInt(t.data("colorpicker").fields.eq(5).val(),10)})),T(o,t.get(0)),j(o,t.get(0))),Z(o,t.get(0)),$(o,t.get(0)),aa(o,t.get(0)),t.data("colorpicker").onChange.apply(t.parent(),[o])},xa=function(a){a.preventDefault?a.preventDefault():a.returnValue=!1;var t={cal:e(this).parents(".kdrawing_colorpicker"),y:e(this).offset().top};e(document).on("mouseup touchend",t,ca),e(document).on("mousemove touchmove",t,sa);var o=a.type=="touchstart"?a.originalEvent.changedTouches[0].pageY:a.pageY;return N.apply(t.cal.data("colorpicker").fields.eq(0).val(parseInt(360*(t.cal.data("colorpicker").height-(o-t.y))/t.cal.data("colorpicker").height,10)).get(0)),!1},sa=function(a){var t=a.type=="touchmove"?a.originalEvent.changedTouches[0].pageY:a.pageY;return N.apply(a.data.cal.data("colorpicker").fields.eq(0).val(parseInt(360*(a.data.cal.data("colorpicker").height-Math.max(0,Math.min(a.data.cal.data("colorpicker").height,t-a.data.y)))/a.data.cal.data("colorpicker").height,10)).get(0)),!1},ca=function(a){return F(a.data.cal.data("colorpicker").color,a.data.cal.get(0)),T(a.data.cal.data("colorpicker").color,a.data.cal.get(0)),e(document).off("mouseup touchend",ca),e(document).off("mousemove touchmove",sa),!1},ka=function(a){a.preventDefault?a.preventDefault():a.returnValue=!1;var t={cal:e(this).parents(".kdrawing_colorpicker"),pos:e(this).offset()};e(document).on("mouseup touchend",t,fa),e(document).on("mousemove touchmove",t,ga);var o,n;return a.type=="touchstart"?(pageX=a.originalEvent.changedTouches[0].pageX,n=a.originalEvent.changedTouches[0].pageY):(pageX=a.pageX,n=a.pageY),N.apply(t.cal.data("colorpicker").fields.eq(2).val(parseInt(100*(t.cal.data("colorpicker").height-(n-t.pos.top))/t.cal.data("colorpicker").height,10)).end().eq(1).val(parseInt(100*(pageX-t.pos.left)/t.cal.data("colorpicker").height,10)).get(0)),!1},ga=function(a){var t,o;return a.type=="touchmove"?(pageX=a.originalEvent.changedTouches[0].pageX,o=a.originalEvent.changedTouches[0].pageY):(pageX=a.pageX,o=a.pageY),N.apply(a.data.cal.data("colorpicker").fields.eq(2).val(parseInt(100*(a.data.cal.data("colorpicker").height-Math.max(0,Math.min(a.data.cal.data("colorpicker").height,o-a.data.pos.top)))/a.data.cal.data("colorpicker").height,10)).end().eq(1).val(parseInt(100*Math.max(0,Math.min(a.data.cal.data("colorpicker").height,pageX-a.data.pos.left))/a.data.cal.data("colorpicker").height,10)).get(0)),!1},fa=function(a){return F(a.data.cal.data("colorpicker").color,a.data.cal.get(0)),T(a.data.cal.data("colorpicker").color,a.data.cal.get(0)),e(document).off("mouseup touchend",fa),e(document).off("mousemove touchmove",ga),!1},P=function(a){return{h:Math.min(360,Math.max(0,a.h)),s:Math.min(100,Math.max(0,a.s)),b:Math.min(100,Math.max(0,a.b))}},ya=function(a){return{r:Math.min(255,Math.max(0,a.r)),g:Math.min(255,Math.max(0,a.g)),b:Math.min(255,Math.max(0,a.b))}},Ca=function(a){var t=6-a.length;if(t>0){for(var o=[],n=0;n<t;n++)o.push("0");o.push(a),a=o.join("")}return a},Ia=function(a,t,o){if(o=typeof o>"u"?1:o,typeof t=="string")t=R(t);else if(t.r!=null&&t.g!=null&&t.b!=null)t=D(t);else if(t.h!=null&&t.s!=null&&t.b!=null)t=P(t);else return!1;var n=e(a);n.data("colorpicker").color=t,F(t,n.get(0)),j(t,n.get(0)),T(t,n.get(0)),$(t,n.get(0)),Z(t,n.get(0)),aa(t,n.get(0)),o&&ra(t,n.get(0))},za=function(a){a.preventDefault();var t=e(this).parents(".kdrawing_colorpicker"),o=t.data("colorpicker").color;t.data("colorpicker").onSubmit(o)};return{init:function(a){if(a=e.extend({},k,a||{}),typeof a.color=="string")a.color=R(a.color);else if(a.color.r!=null&&a.color.g!=null&&a.color.b!=null)a.color=D(a.color);else if(a.color.h!=null&&a.color.s!=null&&a.color.b!=null)a.color=P(a.color);else return this;return this.each(function(){if(!e(this).data("kdrawingId")){var t=e.extend({},a),o=parseInt(Math.random()*1e3),n="kdrawing_"+o;e(this).data("kdrawingId",n);var i=e(p).attr("id",n);t.canvas=e(i).find(".kdrawing_canvas"),t.cursor=e(i).find(".kdrawing_cursor"),t.drawingboard=e(i).find(".kdrawing_drawingboard"),e(i).find(".kdrawing_cover").on("contextmenu",function(){return!1}),i.find(".kdrawing_cover").on("mouseenter",function(d){e(i).addClass("mouseenter"),e(i).hasClass("mousedown")&&H(e(i).get(0),d.offsetX,d.offsetY,d.type)}).on("mouseleave",function(d){e(i).removeClass("mouseenter"),e(i).hasClass("mousedown")&&H(e(i).get(0),d.offsetX,d.offsetY,d.type)}).on("mousedown",function(d){d.preventDefault(),e(":focus").blur(),e(i).addClass("mousedown"),e(i).hasClass("mousedown")&&e(i).hasClass("mouseenter")&&((d.which==2||d.which==3)&&(e(i).data("data").tool_id_org=e(i).data("data").tool_id,X(i,"eraser")),H(e(i).get(0),d.offsetX,d.offsetY,d.type))}).on("mousemove",function(d){e(i).hasClass("mousedown")&&e(i).hasClass("mouseenter")&&H(e(i).get(0),d.offsetX,d.offsetY,d.type)}).on("mouseup",function(d){e(i).data("data").tool_id=="line"&&H(e(i).get(0),d.offsetX,d.offsetY,d.type)}),e("body").on("mouseup",function(){e(".kdrawing_draggable").removeClass("dragging"),e(i).removeClass("mousedown"),e(i).data("data").tool_id_org&&(X(i,e(i).data("data").tool_id_org),e(i).data("data").tool_id_org=!1)}).on("mousemove",function(d){e(i).data("data").mousePos={x:d.pageX,y:d.pageY},e(".kdrawing_draggable.dragging").each(function(h,I){e(this).css({top:d.pageY-e(this).data("top"),left:d.pageX-e(this).data("left")})});var w=t.drawingboard.offset();t.cursor.css({top:d.pageY-w.top-t.cursor.height()/2-3,left:d.pageX-w.left-t.cursor.width()/2-3})}).on("keydown",function(d){if(!(e(":focus").length>0)){var w=e(i).hasClass("mouseenter");switch(d.keyCode){case 187:case 107:G(i,e(i).data("data").tool[e(i).data("data").tool_id].size*1+1);break;case 189:case 109:G(i,e(i).data("data").tool[e(i).data("data").tool_id].size*1-1);break;case 84:d.preventDefault();var h=i.data("data").mousePos;f.css({top:h.y-f.height()/2,left:h.x-f.width()/2});break;case 90:d.preventDefault(),d.ctrlKey&&M(i,"undo");break;case 89:d.preventDefault(),d.ctrlKey&&M(i,"redo");break;case 66:d.preventDefault(),M(i,"pencil");break;case 69:d.preventDefault(),M(i,"eraser");break;case 71:d.preventDefault(),M(i,"paint");break;case 73:d.preventDefault(),M(i,"eyedropper");break;case 85:d.preventDefault(),M(i,"line");break;case 32:d.preventDefault(),e(i).data("data").tool_id!="hand"&&(e(i).data("data").tool_id_org=e(i).data("data").tool_id),e("html").css("cursor","-webkit-grab"),M(i,"hand");break;case 83:d.preventDefault(),d.ctrlKey&&M(i,"save");break;case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:var I=d.keyCode-48,m=e(i).data("data").palette.find(".kdrawing_palette_colors li").eq(I-1);m.length&&q(i,D(ta(m.css("background-color"))));break}}}).on("keyup",function(d){switch(d.keyCode){case 32:e(i).data("data").tool_id_org&&(e("body").removeClass("clicked"),e("html").css("cursor",""),X(i,e(i).data("data").tool_id_org),e(i).data("data").tool_id_org=!1);break}}),i.appendTo(this);var c=i.offset(),f=O("toolbox_"+o,l,c.top,c.left+a.width+6),v=O("palette_"+o,x,c.top,c.left+a.width+46),s=O("colorpicker_"+o,y,c.top,c.left),_=O("alertwindow_"+o,S,c.top,c.left);f.find(".kdrawing_toolbox_tools li.kdrawing_toolbox_tool span").click(function(){M(i.get(0),e(this).data("tool"))}),f.find(".kdrawing_toolbox_size_bar, .kdrawing_toolbox_size_text").change(function(){G(i,parseInt(e(this).val()))}),f.find(".kdrawing_toolbox_color").on("click",function(){!e(i).data("data").tool_id||(Ia(s,e(i).data("data").color,!0),s.data("colorpicker").onSubmit=function(d){q(i,d),s.hide()},e(i).data("data").colorpickerImmediately&&(s.data("colorpicker").onChange=function(d){q(i,d)}),s.show())}),f.find(".kdrawing_toolbox_addpalette").on("click",function(){ia(i,e(i).data("data").color)}),v.find(".kdrawing_palette_colors").on("mousedown","li",function(d){d.preventDefault(),d.which==2||d.which==3?(e(i).data("data").colors.splice(e(this).index(),1),e(this).remove()):q(i,D(ta(e(this).css("background-color"))))}).on("contextmenu",function(){return!1}),s.hide();var u={height:156,color:R("FF0000"),onSubmit:function(){},onChange:function(){}};u.fields=s.find("input").change(N),u.selector=s.find("div.kdrawing_colorpicker_color").on("mousedown touchstart",ka),u.selectorIndic=u.selector.find("div.kdrawing_colorpicker_selector_outer"),u.hue=s.find("div.kdrawing_colorpicker_hue_arrs"),u.newColor=s.find("div.kdrawing_colorpicker_new_color"),u.currentColor=s.find("div.kdrawing_colorpicker_current_color"),s.find("div.kdrawing_colorpicker_hue").on("mousedown touchstart",xa),s.find("form").on("submit",za),s.find(".kdrawing_colorpicker_cancel").click(function(){e(s).hide()}),s.data("colorpicker",u),F(u.color,s.get(0)),j(u.color,s.get(0)),T(u.color,s.get(0)),$(u.color,s.get(0)),Z(u.color,s.get(0)),ra(u.color,s.get(0)),aa(u.color,s.get(0)),_.hide(),_.find(".kdrawing_alertwindow_close").click(function(){oa(e(i).get(0))}),f.appendTo("body"),v.appendTo("body"),s.appendTo("body"),_.appendTo("body"),t.toolbox=f,t.palette=v,t.colorpicker=s,t.alertwindow=_,i.data("data",t),K(i,t.width,t.height),U(i),na(i),X(i,t.tool_id),t.onReady.apply(e(i).parent())}})},getSetting:function(){if(e(this).data("kdrawingId"))return kdr=e("#"+e(this).data("kdrawingId")),kdr.data("data")},showAlert:function(a,t){e(this).data("kdrawingId")&&(kdr=e("#"+e(this).data("kdrawingId")),ea(kdr,{id:"alert",text:a,onSubmit:t}))},showFadeAlert:function(a,t){e(this).data("kdrawingId")&&(t=typeof t<"u"?t:!0,kdr=e("#"+e(this).data("kdrawingId")),z(kdr,a,t))}}}(),ua=function(l){var l=parseInt(l.indexOf("#")>-1?l.substring(1):l,16);return{r:l>>16,g:(l&65280)>>8,b:l&255}},R=function(p){return D(ua(p))},D=function(p){var l={h:0,s:0,b:0},x=Math.min(p.r,p.g,p.b),y=Math.max(p.r,p.g,p.b),S=y-x;return l.b=y,l.s=y!=0?255*S/y:0,l.s!=0?p.r==y?l.h=(p.g-p.b)/S:p.g==y?l.h=2+(p.b-p.r)/S:l.h=4+(p.r-p.g)/S:l.h=-1,l.h*=60,l.h<0&&(l.h+=360),l.s*=100/255,l.b*=100/255,l},W=function(p){var l={},x=p.h,y=p.s*255/100,S=p.b*255/100;if(y==0)l.r=l.g=l.b=S;else{var k=S,C=(255-y)*S/255,z=(k-C)*(x%60)/60;x==360&&(x=0),x<60?(l.r=k,l.b=C,l.g=C+z):x<120?(l.g=k,l.b=C,l.r=k-z):x<180?(l.g=k,l.r=C,l.b=C+z):x<240?(l.b=k,l.r=C,l.g=k-z):x<300?(l.b=k,l.g=C,l.r=C+z):x<360?(l.r=k,l.g=C,l.b=k-z):(l.r=0,l.g=0,l.b=0)}return{r:Math.round(l.r),g:Math.round(l.g),b:Math.round(l.b)}},pa=function(p){var l=[p.r.toString(16),p.g.toString(16),p.b.toString(16)];return e.each(l,function(x,y){y.length==1&&(l[x]="0"+y)}),l.join("")},Y=function(p){return pa(W(p))},ta=function(p){return p=p.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/),{r:p[1]*1,g:p[2]*1,b:p[3]*1}};e.fn.extend({kdrawing:B.init,kdrawingGetSetting:B.getSetting,kdrawingAlert:B.showAlert,kdrawingFadeAlert:B.showFadeAlert})})(jQuery);
